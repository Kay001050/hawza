<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ديوان المراجعات والمسائل | لوحة تحكم نور الحوزة</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  
  <link rel="icon" href="Icon.png" type="image/png">
  
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <style>
    :root {
      --font-title: 'Scheherazade New', serif;
      --font-body: 'Cairo', sans-serif;
      --color-bg-parchment: #fdfaf3;
      --color-surface: #ffffff;
      --color-ink-primary: #3a2d21;
      --color-ink-secondary: #7a6a5d;
      --color-hawza-green: #054a29;
      --color-hawza-green-light: #e6f4ea;
      --color-gold-accent: #c5a47e;
      --color-gold-hover: #b38f5f;
      --color-danger: #c0392b;
      --color-border: #e9e4dc;
      --shadow-soft: 0 4px 12px rgba(58, 45, 33, 0.07);
      --shadow-medium: 0 8px 25px rgba(58, 45, 33, 0.1);
      --border-radius: 8px;
      --transition-main: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-body);
      background-color: var(--color-bg-parchment);
      color: var(--color-ink-primary);
      margin: 0;
      line-height: 1.8;
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .hidden { display: none !important; }
    #master-loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(253, 250, 243, 0.85);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999; backdrop-filter: blur(3px); transition: opacity 0.3s;
    }
    #master-loader .spinner {
      border: 5px solid var(--color-gold-accent);
      border-top-color: var(--color-hawza-green);
      border-radius: 50%; width: 50px; height: 50px;
      animation: spin 1s linear infinite;
    }
    #toast-container {
      position: fixed; bottom: 20px; left: 20px; z-index: 10000;
      display: flex; flex-direction: column; gap: 10px;
    }
    .toast {
      padding: 15px 20px;
      background: var(--color-ink-primary); color: white; border-radius: 5px; box-shadow: var(--shadow-medium);
      animation: slideInUp 0.5s ease;
    }
    .toast.success { background: var(--color-hawza-green); }
    .toast.error { background: var(--color-danger); }
    #login-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--color-bg-parchment) url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23e9e4dc" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: opacity var(--transition-main);
    }
    #login-form {
      background: var(--color-surface); padding: 3rem; text-align: center;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
      width: 90%; max-width: 450px; border: 1px solid var(--color-border);
      animation: fadeInScale 0.6s ease-out;
    }
    #login-form h1 {
      font-family: var(--font-title); font-size: 3rem; color: var(--color-hawza-green);
      margin: 0;
    }
    #login-form .subtitle { font-family: var(--font-body); color: var(--color-ink-secondary); margin-bottom: 2rem; }
    #login-form input {
      width: 100%; padding: 12px 15px; margin-bottom: 1rem;
      border: 1px solid var(--color-border);
      border-radius: 4px; font-family: var(--font-body); font-size: 1rem; text-align: center;
    }
    .btn {
      padding: 10px 20px; font-family: var(--font-body); font-weight: 600; font-size: 1rem;
      border: none; border-radius: 4px; cursor: pointer; transition: var(--transition-main);
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;
    }
    .btn-primary { background-color: var(--color-hawza-green); color: white; }
    .btn-primary:hover { background-color: #033a20; transform: translateY(-2px); }
    .btn-primary:disabled { background-color: #cccccc; cursor: not-allowed; transform: none; }
    #login-error { color: var(--color-danger); margin-top: 1rem; font-weight: 600; min-height: 24px; }
    #dashboard-container { display: flex; min-height: 100vh; background: var(--color-surface); }
    .sidebar {
        width: 300px;
        background-color: var(--color-bg-parchment);
        border-left: 1px solid var(--color-border); padding: 1.5rem;
        display: flex; flex-direction: column; position: fixed; top: 0; right: 0; height: 100vh;
        overflow-y: auto;
    }
    .main-content { margin-right: 300px; flex-grow: 1; padding: 2rem 3rem; }
    .sidebar-header { text-align: center; padding-bottom: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); }
    .sidebar-header h2 { font-family: var(--font-title); font-size: 2.5rem; color: var(--color-hawza-green); margin: 0; }
    .stats-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem; }
    .stat-card {
      background: var(--color-surface); padding: 1rem; border-radius: var(--border-radius);
      border-right: 4px solid var(--color-gold-accent); text-align: right;
    }
    .stat-card h3 { margin: 0 0 0.5rem; font-size: 0.9rem; color: var(--color-ink-secondary); }
    .stat-card p { margin: 0; font-size: 2rem; font-weight: 700; color: var(--color-ink-primary); }
    .sidebar-section h3 { font-family: var(--font-title); font-size: 1.5rem; color: var(--color-hawza-green); margin-bottom: 1rem; border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; }
    #tags-filter-list { list-style: none; padding: 0; }
    #tags-filter-list li {
      padding: 8px 12px; margin-bottom: 5px; border-radius: 4px;
      cursor: pointer;
      transition: var(--transition-main);
    }
    #tags-filter-list li:hover { background-color: var(--color-hawza-green-light); }
    #tags-filter-list li.active { background-color: var(--color-gold-accent); color: white; font-weight: 700; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--color-border); }
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .main-header h1 { font-family: var(--font-title); font-size: 2.8rem; color: var(--color-hawza-green); margin: 0; }
    .filter-controls {
      display: flex; gap: 1rem;
      align-items: center; background-color: var(--color-bg-parchment);
      padding: 1rem; border-radius: var(--border-radius); margin-bottom: 2rem;
    }
    .search-bar { position: relative; flex-grow: 1; }
    .search-bar input { width: 100%; padding: 10px 40px 10px 15px; border: 1px solid var(--color-border); border-radius: 4px; }
    .search-bar .fa-search { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--color-ink-secondary); }
    .question-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      margin-bottom: 1.5rem; padding: 1.5rem 2rem; border-radius: var(--border-radius);
      box-shadow: var(--shadow-soft); transition: var(--transition-main);
      border-right: 5px solid var(--color-gold-accent); /* Unanswered */
    }
    .question-card.answered { border-right-color: var(--color-hawza-green); }
    .question-card:hover { box-shadow: var(--shadow-medium); transform: translateY(-5px); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px;}
    .card-meta span { color: var(--color-ink-secondary); font-size: 0.9rem; }
    .card-actions .btn { padding: 5px 10px; font-size: 0.9rem; }
    .question-body { font-size: 1.15rem; margin-bottom: 1rem; line-height: 1.9; white-space: pre-wrap; word-wrap: break-word; }
    .question-body .search-highlight { background-color: #fff2b2; }
    .card-tags { display: flex; gap: 8px; margin-top: 1rem; flex-wrap: wrap; }
    .tag { background-color: var(--color-hawza-green-light); color: var(--color-hawza-green); padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; }
    .answer-display { margin-top: 1rem; padding: 1rem; background: var(--color-bg-parchment); border-radius: 4px; }
    .answer-display strong { color: var(--color-hawza-green); }
    .modal-backdrop {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(58, 45, 33, 0.6); backdrop-filter: blur(5px);
      display: flex; justify-content: center;
      align-items: center; z-index: 5000;
      animation: fadeIn 0.3s;
      overflow-y: auto;
    }
    .modal-content {
      background: var(--color-surface);
      padding: 2rem; border-radius: var(--border-radius);
      width: 90%; max-width: 800px; box-shadow: var(--shadow-medium);
      border-top: 5px solid var(--color-gold-accent);
      margin: 2rem 0;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; margin-bottom: 1.5rem; }
    .modal-header h3 { font-family: var(--font-title); font-size: 2rem; color: var(--color-hawza-green); margin: 0; }
    .modal-body label { font-weight: 700; margin-bottom: 0.5rem; display: block; }
    .modal-body input, .modal-body textarea {
      width: 100%; padding: 10px; margin-bottom: 1rem;
      border-radius: 4px; border: 1px solid var(--color-border);
      font-family: var(--font-body);
    }
    .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; }
    .quill-editor-container .ql-toolbar { border-color: var(--color-border); border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); }
    .quill-editor-container .ql-container { border-color: var(--color-border); border-bottom-left-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); }
    .quill-editor-container .ql-editor { min-height: 250px; font-family: var(--font-body); font-size: 1rem; }
    @media (max-width: 992px) {
      .sidebar { position: static; width: 100%; height: auto; border-left: none; border-bottom: 2px solid var(--color-border); }
      .main-content { margin-right: 0; padding: 1.5rem; }
      .main-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
      #dashboard-container { flex-direction: column; }
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

  <div id="master-loader">
    <div class="spinner"></div>
  </div>

  <div id="toast-container"></div>
  
  <div id="login-container">
    <form id="login-form">
      <h1><i class="fas fa-mosque" style="color: var(--color-gold-accent);"></i></h1>
      <h1>ديوان المراجعات</h1>
      <p class="subtitle">لوحة التحكم الخاصة بمشروع نور الحوزة</p>
      <input type="password" id="password-input" placeholder="مفتاح الدخول" required>
      <div id="login-error"></div>
      <button type="submit" id="login-button" class="btn btn-primary" style="width: 100%; padding: 12px;">
        <i class="fas fa-sign-in-alt"></i> بسم الله، دخول
      </button>
    </form>
  </div>

  <main id="dashboard-container" class="hidden">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>نور الحوزة</h2>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card"><h3>إجمالي المسائل</h3><p id="stat-total">0</p></div>
            <div class="stat-card" style="border-right-color: var(--color-hawza-green)"><h3>المسائل المجابة</h3><p id="stat-answered">0</p></div>
            <div class="stat-card" style="border-right-color: var(--color-danger)"><h3>قيد المراجعة</h3><p id="stat-unanswered">0</p></div>
        </div>

        <div class="sidebar-section">
            <h3><i class="fas fa-tags"></i> التصنيفات</h3>
            <ul id="tags-filter-list">
                <li data-tag="all" class="active">الكل</li>
            </ul>
        </div>
        
        <div class="sidebar-footer">
            <button id="logout-btn" class="btn" style="background-color: var(--color-danger); color: white; width: 100%;">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>
    </aside>

    <section class="main-content">
        <div class="main-header">
            <h1><i class="fas fa-scroll"></i> ديوان المسائل</h1>
            <button id="add-new-question-btn" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة مسألة جديدة</button>
        </div>
        
        <div class="filter-controls">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="ابحث في نص المسألة، الجواب، المصدر أو التصنيف...">
            </div>
        </div>
        
        <div id="questions-list">
            </div>
    </section>
  </main>

  <div id="edit-modal-container" class="modal-backdrop hidden">
    <div class="modal-content">
        <form id="edit-form" novalidate>
            <input type="hidden" id="edit-id-input">
            <div class="modal-header">
                <h3 id="modal-title">تحرير المسألة</h3>
                <button type="button" class="close-modal-btn" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div>
                    <label for="edit-question-input">نص المسألة</label>
                    <textarea id="edit-question-input" rows="3" required></textarea>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div style="flex:1; min-width: 250px;">
                        <label for="edit-source-input">المصدر (اختياري)</label>
                        <input type="text" id="edit-source-input" placeholder="مثال: بحار الأنوار، ج52، ص123">
                    </div>
                    <div style="flex:1; min-width: 250px;">
                        <label for="edit-tags-input">التصنيفات (مفصولة بفاصلة)</label>
                        <input type="text" id="edit-tags-input" placeholder="عقائد, فقه, شبهات">
                    </div>
                </div>
                <div>
                    <label>الجواب</label>
                    <div id="quill-editor-container" class="quill-editor-container"></div>
                    <small id="draft-status" style="color: var(--color-ink-secondary); margin-top: 5px; display: block; min-height: 1em;"></small>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" id="delete-btn" class="btn" style="background:var(--color-danger); color:white; margin-left: auto;">
                    <i class="fas fa-trash-alt"></i> حذف المسألة
                </button>
                <button type="button" class="close-modal-btn btn" style="background:#eee; color: #333;">إلغاء</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ التغييرات</button>
            </div>
        </form>
    </div>
  </div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    
    class ApiService {
        constructor(baseURL = '/.netlify/functions/api') {
            this.baseURL = baseURL;
        }

        async request(endpoint, options = {}) {
            const url = this.baseURL + endpoint;
            const config = {
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                ...options,
            };

            if (config.body) {
                config.body = JSON.stringify(config.body);
            }

            try {
                const response = await fetch(url, config);
                const data = await response.json().catch(() => ({}));

                if (!response.ok) {
                    const errorMsg = data.error || `خطأ في الخادم برمز الحالة ${response.status}`;
                    throw new Error(errorMsg);
                }
                return data;
            } catch (error) {
                console.error(`API Error on ${endpoint}:`, error);
                throw new Error(error.message || "خطأ في الاتصال بالشبكة.");
            }
        }
        
        checkStatus() { return this.request('/admin/status'); }
        login(password) { return this.request('/admin/login', { method: 'POST', body: { password } }); }
        logout() { return this.request('/admin/logout', { method: 'POST' }); }
        getQuestions() { return this.request('/admin/questions'); }
        addQuestion(data) { return this.request('/admin/question', { method: 'POST', body: data }); }
        updateQuestion(id, data) { return this.request(`/admin/question/${id}`, { method: 'PUT', body: data }); }
        deleteQuestion(id) { return this.request(`/admin/question/${id}`, { method: 'DELETE' }); }
    }

    class StateService {
        constructor() {
            this._state = {
                isLoggedIn: false,
                questions: [],
                searchTerm: '',
                activeTag: 'all',
                allTags: new Set(),
            };
        }
        
        get state() { return this._state; }
        
        setQuestions(questions) {
            this._state.questions = questions;
            this.updateTags();
        }

        updateQuestion(updatedQuestion) {
            const index = this._state.questions.findIndex(q => q.id === updatedQuestion.id);
            if (index !== -1) {
                this._state.questions[index] = updatedQuestion;
            } else {
                this._state.questions.unshift(updatedQuestion);
            }
            this._state.questions.sort((a, b) => new Date(b.date) - new Date(a.date));
            this.updateTags();
        }

        removeQuestion(id) {
            this._state.questions = this._state.questions.filter(q => q.id !== id);
            this.updateTags();
        }

        updateTags() {
            this._state.allTags.clear();
            this._state.questions.forEach(q => {
                if (q.tags && Array.isArray(q.tags)) {
                    q.tags.forEach(tag => this._state.allTags.add(tag));
                }
            });
        }
        
        getFilteredQuestions() {
            const { questions, activeTag, searchTerm } = this._state;
            const term = searchTerm.toLowerCase().trim();

            return questions
                .filter(q => {
                    if (activeTag === 'all') return true;
                    if (activeTag === '__unanswered') return !q.answer || q.answer.trim() === '';
                    return (q.tags && q.tags.includes(activeTag));
                })
                .filter(q => {
                    if (!term) return true;
                    const answerText = q.answer ? new DOMParser().parseFromString(q.answer, "text/html").body.textContent.toLowerCase() : '';
                    return (
                        q.question.toLowerCase().includes(term) ||
                        answerText.includes(term) ||
                        (q.source && q.source.toLowerCase().includes(term)) ||
                        (q.tags && q.tags.some(tag => tag.toLowerCase().includes(term)))
                    );
                });
        }
    }

    class UIController {
        constructor() {
            this.dom = {
                loader: document.getElementById('master-loader'),
                toastContainer: document.getElementById('toast-container'),
                login: {
                    container: document.getElementById('login-container'),
                    form: document.getElementById('login-form'),
                    passwordInput: document.getElementById('password-input'),
                    errorMsg: document.getElementById('login-error'),
                    button: document.getElementById('login-button'),
                },
                dashboard: {
                    container: document.getElementById('dashboard-container'),
                    logoutBtn: document.getElementById('logout-btn'),
                    addNewBtn: document.getElementById('add-new-question-btn'),
                    stats: {
                        total: document.getElementById('stat-total'),
                        answered: document.getElementById('stat-answered'),
                        unanswered: document.getElementById('stat-unanswered'),
                    },
                    tagsFilterList: document.getElementById('tags-filter-list'),
                    searchInput: document.getElementById('search-input'),
                    questionsList: document.getElementById('questions-list'),
                },
                modal: {
                    container: document.getElementById('edit-modal-container'),
                    form: document.getElementById('edit-form'),
                    title: document.getElementById('modal-title'),
                    idInput: document.getElementById('edit-id-input'),
                    questionInput: document.getElementById('edit-question-input'),
                    sourceInput: document.getElementById('edit-source-input'),
                    tagsInput: document.getElementById('edit-tags-input'),
                    deleteBtn: document.getElementById('delete-btn'),
                    draftStatus: document.getElementById('draft-status'),
                    closeBtns: document.querySelectorAll('.close-modal-btn'),
                }
            };
            this.quill = this.initQuill();
            this.draftSaveInterval = null;
        }

        initQuill() {
            return new Quill('#quill-editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'],
                        [{'list': 'ordered'}, {'list': 'bullet'}], [{'align': []}],
                        ['link', 'blockquote', 'code-block'], ['clean']
                    ]
                }
            });
        }

        toggleLoader(show) { this.dom.loader.style.opacity = show ? '1' : '0'; this.dom.loader.style.pointerEvents = show ? 'all' : 'none'; }
        
        showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            this.dom.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        renderDashboard(state) {
            this.renderStats(state.questions);
            this.renderTags(state.allTags, state.activeTag);
            this.renderQuestions(state.getFilteredQuestions(), state.searchTerm);
        }
        
        renderStats(questions) {
            const total = questions.length;
            const answered = questions.filter(q => q.answer && q.answer.trim() !== '').length;
            this.dom.dashboard.stats.total.textContent = total;
            this.dom.dashboard.stats.answered.textContent = answered;
            this.dom.dashboard.stats.unanswered.textContent = total - answered;
        }
        
        renderTags(tags, activeTag) {
            const list = this.dom.dashboard.tagsFilterList;
            const unansweredCount = this.dom.dashboard.stats.unanswered.textContent;

            list.innerHTML = `<li data-tag="all" class="${activeTag === 'all' ? 'active' : ''}">الكل</li>
                              <li data-tag="__unanswered" class="${activeTag === '__unanswered' ? 'active' : ''}">قيد المراجعة (${unansweredCount})</li>`;
            
            const sortedTags = Array.from(tags).sort();
            sortedTags.forEach(tag => {
                const li = document.createElement('li');
                li.dataset.tag = tag;
                li.textContent = tag;
                if (tag === activeTag) li.classList.add('active');
                list.appendChild(li);
            });
        }

        renderQuestions(questions, searchTerm) {
            const list = this.dom.dashboard.questionsList;
            list.innerHTML = '';
            if (questions.length === 0) {
                list.innerHTML = `<p style="text-align:center; padding: 3rem; color: var(--color-ink-secondary);">لا توجد مسائل تطابق البحث الحالي.</p>`;
                return;
            }
            questions.forEach(q => list.appendChild(this.createQuestionCard(q, searchTerm)));
        }

        createQuestionCard(q, searchTerm) {
            const card = document.createElement('div');
            card.className = `question-card ${q.answer && q.answer.trim() !== '' ? 'answered' : 'unanswered'}`;
            card.dataset.id = q.id;

            const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            
            const highlight = (text) => {
                if (!searchTerm || !text) return escapeHtml(text || '');
                const escapedTerm = escapeHtml(searchTerm);
                const regex = new RegExp(`(${escapedTerm})`, 'gi');
                return escapeHtml(text).replace(regex, `<span class="search-highlight">$1</span>`);
            };

            const tagsHTML = (q.tags || []).map(tag => `<span class="tag">${highlight(tag)}</span>`).join('');
            const date = new Date(q.date).toLocaleDateString('ar-EG-u-nu-latn', { day: 'numeric', month: 'long', year: 'numeric' });
            
            const answerExcerpt = q.answer ? new DOMParser().parseFromString(q.answer, "text/html").body.textContent || '' : '';

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-meta"><span>بتاريخ: ${date}</span></div>
                    <div class="card-actions"><button class="btn btn-primary btn-sm edit-btn"><i class="fas fa-edit"></i> تحرير</button></div>
                </div>
                <div class="question-body">${highlight(q.question)}</div>
                ${q.source ? `<p class="card-meta"><strong>المصدر:</strong> ${highlight(q.source)}</p>` : ''}
                ${tagsHTML ? `<div class="card-tags">${tagsHTML}</div>` : ''}
                ${answerExcerpt ? `<div class="answer-display"><strong>الجواب:</strong> ${escapeHtml(answerExcerpt.substring(0, 200))}...</div>` : ''}
            `;
            return card;
        }
        
        showLogin() {
            this.dom.login.container.classList.remove('hidden');
            this.dom.dashboard.container.classList.add('hidden');
            this.toggleLoader(false);
        }
        
        showDashboard() {
            this.dom.login.container.classList.add('hidden');
            this.dom.dashboard.container.classList.remove('hidden');
        }

        openModal(question) {
            const isNew = !question;
            this.dom.modal.form.reset();
            this.dom.modal.title.textContent = isNew ? 'إضافة مسألة جديدة' : 'تحرير المسألة';
            this.dom.modal.idInput.value = isNew ? '' : question.id;
            this.dom.modal.questionInput.value = isNew ? '' : question.question;
            this.dom.modal.sourceInput.value = isNew ? '' : (question.source || '');
            this.dom.modal.tagsInput.value = isNew ? '' : (question.tags || []).join(', ');
            this.quill.root.innerHTML = isNew ? '' : (question.answer || '');
            this.dom.modal.deleteBtn.style.display = isNew ? 'none' : 'inline-flex';
            this.dom.modal.container.classList.remove('hidden');

            this.handleDrafts(isNew ? `new_question` : question.id);
        }

        closeModal() {
            this.dom.modal.container.classList.add('hidden');
            clearInterval(this.draftSaveInterval);
            this.draftSaveInterval = null;
            this.dom.modal.draftStatus.textContent = '';
        }

        handleDrafts(draftId) {
            if (this.draftSaveInterval) clearInterval(this.draftSaveInterval);

            const draftKey = `draft_${draftId}`;
            const savedDraft = localStorage.getItem(draftKey);
            if (savedDraft) {
                try {
                    const draftContent = JSON.parse(savedDraft);
                    if (confirm("يوجد مسودة محفوظة لهذه المسألة. هل تود استعادتها؟")) {
                        this.quill.root.innerHTML = draftContent.answer || '';
                        this.dom.modal.questionInput.value = draftContent.question || '';
                        this.dom.modal.sourceInput.value = draftContent.source || '';
                        this.dom.modal.tagsInput.value = draftContent.tags || '';
                    }
                } catch(e) { console.error("Failed to parse draft", e); localStorage.removeItem(draftKey); }
            }

            this.draftSaveInterval = setInterval(() => {
                const currentContent = {
                    answer: this.quill.root.innerHTML,
                    question: this.dom.modal.questionInput.value,
                    source: this.dom.modal.sourceInput.value,
                    tags: this.dom.modal.tagsInput.value
                };
                localStorage.setItem(draftKey, JSON.stringify(currentContent));
                this.dom.modal.draftStatus.textContent = `تم حفظ المسودة في ${new Date().toLocaleTimeString('ar')}`;
            }, 10000);
        }

        clearDraft(draftId) {
            if (!draftId) return;
            localStorage.removeItem(`draft_${draftId}`);
        }
    }
    
    class AppController {
        constructor() {
            this.api = new ApiService();
            this.state = new StateService();
            this.ui = new UIController();
            this.init();
        }

        init() {
            this.ui.toggleLoader(true);
            this.bindEvents();
            this.checkSession();
        }

        bindEvents() {
            this.ui.dom.login.form.addEventListener('submit', (e) => this.handleLogin(e));
            this.ui.dom.dashboard.logoutBtn.addEventListener('click', () => this.handleLogout());
            this.ui.dom.dashboard.addNewBtn.addEventListener('click', () => this.ui.openModal(null));
            
            this.ui.dom.modal.closeBtns.forEach(btn => btn.addEventListener('click', () => this.ui.closeModal()));
            this.ui.dom.modal.form.addEventListener('submit', (e) => this.handleFormSubmit(e));
            this.ui.dom.modal.deleteBtn.addEventListener('click', () => this.handleDelete());
            
            this.ui.dom.dashboard.questionsList.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    const card = e.target.closest('.question-card');
                    const question = this.state.state.questions.find(q => q.id === Number(card.dataset.id));
                    if(question) this.ui.openModal(question);
                }
            });

            this.ui.dom.dashboard.searchInput.addEventListener('input', e => {
                this.state.state.searchTerm = e.target.value;
                this.ui.renderQuestions(this.state.getFilteredQuestions(), this.state.state.searchTerm);
            });

            this.ui.dom.dashboard.tagsFilterList.addEventListener('click', e => {
                if(e.target.tagName === 'LI') {
                    this.state.state.activeTag = e.target.dataset.tag;
                    this.ui.renderDashboard(this.state);
                }
            });
        }

        async checkSession() {
            try {
                await this.api.checkStatus();
                this.state.state.isLoggedIn = true;
                this.ui.showDashboard();
                await this.fetchData();
            } catch (error) {
                this.state.state.isLoggedIn = false;
                this.ui.showLogin();
            }
        }

        async handleLogin(e) {
            e.preventDefault();
            this.ui.dom.login.button.disabled = true;
            this.ui.dom.login.errorMsg.textContent = '';
            const password = this.ui.dom.login.passwordInput.value;
            try {
                await this.api.login(password);
                this.ui.toggleLoader(true);
                await this.checkSession();
            } catch (error) {
                this.ui.dom.login.errorMsg.textContent = error.message;
            } finally {
                this.ui.dom.login.button.disabled = false;
            }
        }

        async handleLogout() {
            this.ui.toggleLoader(true);
            try {
                await this.api.logout();
                this.state.state.isLoggedIn = false;
                this.state.setQuestions([]);
                this.ui.showLogin();
            } catch (error) {
                this.ui.showToast(error.message, 'error');
                this.ui.toggleLoader(false);
            }
        }

        async fetchData() {
            this.ui.toggleLoader(true);
            try {
                const questions = await this.api.getQuestions();
                this.state.setQuestions(questions);
                this.ui.renderDashboard(this.state);
            } catch(error) {
                this.ui.showToast(error.message, 'error');
            } finally {
                this.ui.toggleLoader(false);
            }
        }
        
        async handleFormSubmit(e) {
            e.preventDefault();
            const id = this.ui.dom.modal.idInput.value;
            const data = {
                question: this.ui.dom.modal.questionInput.value,
                source: this.ui.dom.modal.sourceInput.value,
                tags: this.ui.dom.modal.tagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
                answer: this.ui.quill.root.innerHTML
            };
            if (!data.question) {
                this.ui.showToast("نص المسألة لا يمكن أن يكون فارغًا.", "error");
                return;
            }
            
            this.ui.toggleLoader(true);
            try {
                const response = id ? await this.api.updateQuestion(Number(id), data) : await this.api.addQuestion(data);
                this.state.updateQuestion(response.question);
                this.ui.renderDashboard(this.state);
                this.ui.closeModal();
                this.ui.clearDraft(id || 'new_question');
                this.ui.showToast("تم حفظ المسألة بنجاح.", "success");
            } catch(error) {
                this.ui.showToast(error.message, 'error');
            } finally {
                this.ui.toggleLoader(false);
            }
        }

        async handleDelete() {
            const id = Number(this.ui.dom.modal.idInput.value);
            if (!id || !confirm("هل أنت متأكد من رغبتك في حذف هذه المسألة؟ لا يمكن التراجع عن هذا الإجراء.")) return;

            this.ui.toggleLoader(true);
            try {
                await this.api.deleteQuestion(id);
                this.state.removeQuestion(id);
                this.ui.renderDashboard(this.state);
                this.ui.closeModal();
                this.ui.clearDraft(id);
                this.ui.showToast("تم حذف المسألة بنجاح.", "success");
            } catch (error) {
                this.ui.showToast(error.message, "error");
            } finally {
                this.ui.toggleLoader(false);
            }
        }
    }

    new AppController();
});
</script>
</body>
</html>
